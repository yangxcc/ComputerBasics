## 软中断

### 中断

首先，我们需要先明确一下中断的概念

中断是操作系统用来响应硬件设备请求的一种机制，操作系统收到硬件设备的中断请求之后，会打断正在执行的进程，然后调用内核中的中断处理程序来响应请求

```shell
# 例子
# 比方说小林打了一个外卖，付完钱之后虽然能够在平台上看到配送时间以及路程，但是小林也不可能一直盯着手机看，这个过程中它会去做别的事情，等到外卖到了快递小哥会打电话（中断请求），这时候小林会放下手头上的工作去拿外卖
```

从上面的例子中可以看出，**中断是一种异步的事件处理机制，**可以提高系统的并发处理能力

操作系统**收到中断请求之后，会打断其他正在执行的进程**，所以中断处理程序应该尽可能快的执行完，这样能够减少对其他进程的影响

```shell
# 例子2
# 小林晚上点了两份外卖，其中有一份外卖先到了，外卖员给小林打电话，但是说了很长时间，在此期间，第二份外卖也到了，这时第二个外卖员给小林打电话打不通（中断丢失）
```

从上面的例子中可以看出，**中断处理程序在响应中断的时候可能会临时关闭中断**，这意味着如果当前中断处理程序没有执行完的话，其他的中断请求也没有办法响应，导致中断丢失，因此**中断处理程序应该尽可能快的执行完**



### 软中断

前面我们说到了，中断处理程序要尽可能地短而且快，尽可能地减少对正常进程的干扰，而且中断处理程序可能会临时关闭中断，如果中断处理程序执行时间过长，那么可能造成中断丢失，那么**Linux为了解决中断处理程序执行时间过程和中断丢失这两个问题，将中断过程分成了上下两个部分：**

> **<font color=red>首先通过网卡接收网络包为例，来说明中断过程的两个部分</font>**
>
> 网卡收到网络包之后，首先会通过硬件中断通知内核有数据包到了，于是内核就会调用中断处理程序来响应该事件，这个事件的处理也分为上下两个部分：
>
> 上半部分要做到快速处理，所以只要把网卡中的数据读取到内存中，然后再更新一下硬件寄存器的状态，比如把状态更新为表示数据已经读取到内存中的状态；接着内核会触发一个软中断，把一些处理起来比较耗时的事情交给软中断处理程序来执行，这也就是软中断的下半部，其主要是从内存中找到网络数据，再按照网络协议栈，对网络包逐层解析和处理，然后最后把数据发送给应用程序

通过上面的例子，我们可以看出，中断过程的两个部分可以分为：

- 上半部分直接处理硬件请求，也就是**硬中断**，主要负责耗时短的工作，特点是快速执行
- 下半部分由内核触发，也就是**软中断**，主要负责上半部分未完成的工作，通常是耗时比较长的事情，特点是延迟执行

硬中断和软中断还有一个重要的区别：硬中断会打断CPU正在执行的任务，然后立即执行中断处理程序，而**软中断则是以内核线程的方式执行，**每个CPU上都对应了一个软中断内核线程，名字通常是`ksoftirqd/cpu编号`

**注意：软中断不仅仅是指中断处理程序的下半部分，一些内核自定义的事件也属于软中断，比如内核调度，RCU锁等**



在Linux系统中我们可以通过`cat /proc/softirqs`来查看系统中的软中断，`cat /proc/interrupts`查看系统中的硬中断

<img src="../../image/OperationSystem/image-20211117202506449.png" alt="image-20211117202506449" style="zoom:67%;" />

上图中有两个地方需要我们注意：

- 第一列表示的是软中断的类型，共10种，分别对应着不同的工作类型，比如`NET_TX`表示网络发送中断，`NET_RX`表示网络接收中断，`TIMER`表示定时中断，`RCU`表示RCU锁中断，`SCHED`表示内核调度中断

  我们前面说到软中断是以内核线程的方式执行的，所以我们可以使用`ps`命令查看得到，如下图

  <img src="../../image/OperationSystem/image-20211117203628658.png" alt="image-20211117203628658" style="zoom:67%;" />

  ```
  上面这张图是小林的，他电脑上有4个CPU核心，每个CPU核心上有一个软中断线程，所以上图中有4个
  名字在中括号里面的都可以看作是内核线程
  ```

  

- 第二点需要注意的是，图中列出的都是累计值，没有什么太大的参考价值，我们可以使用`watch -d cat /proc/softirqs`来查看软中断的变化速率，如下图：

  ![image-20211117203023211](../../image/OperationSystem/image-20211117203023211.png)

  一般对于网络I/O比较高的web服务器，`NET_RX`的变化速率会比较快，如果发现`NET_RX`的变化速率过快，接下来就可以使用`sar -n DEV`查看网卡的网络包接受速率，然后分析是哪个网卡有大量的网络包进来

  ![image-20211117204225482](../../image/OperationSystem/image-20211117204225482.png)

  接着，再通过 `tcpdump` 抓包，分析这些包的来源，如果是非法的地址，可以考虑加防火墙，如果是正常 流量，则要考虑硬件升级等



















